<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="utf-8">
    <title>Historique des Transactions</title>
    <link rel="stylesheet" href="/style.css">
    <link href='https://fonts.googleapis.com/css?family=Open Sans' rel='stylesheet'>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/js/history"></script>
</head>

<body class="bg-gray-100 text-gray-900">

    <!-- En-tête -->
    <header class="mb-6">
        <div class="flex items-center justify-between" id="header">
            <div class="flex items-center px-4 py-2">
                <div>
                    <img src="/images/logo.png" />
                </div>
                <div>
                    <h1>BNP Paribas</h1>
                </div>
                <div>
                    <h1>&#65372</h1>
                </div>
                <div>
                    <h1>Gestion de Comptes et Transactions Bancaires en Ligne</h1>
                </div>
            </div>
            <div>
                <a href="/profile"
                    class="flex items-center justify-center w-10 h-10 rounded-full bg-gray-100 hover:bg-gray-200">
                    <i class="fas fa-user text-xl text-[#008250]"></i>
                </a>
            </div>
        </div>
    </header>

    <div id="notification"
        class="hidden bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4 mx-auto w-1/2 flex justify-between items-center"
        role="alert">
        <span class="block sm:inline" id="notification-message"></span>
        <button type="button" class="text-green-700 hover:text-green-900" onclick="closeNotification()">
            &times; <!-- Symbole de fermeture -->
        </button>
    </div>

    <!-- Corps de la page -->
    <div class="flex flex-col items-center min-h-screen space-y-8">

        <!-- Bouton de retour à la page d'accueil -->
        <a href="/dashboard" class="mb-4">
            <img src="/images/logo.png" alt="Accueil"
                class="w-28 h-28 rounded-full hover:opacity-80 transition-opacity duration-200" />
        </a>

        <!-- Titre de la page -->
        <h2 class="text-4xl font-extrabold">Historique des transactions</h2>

        <!-- Boutons d'actions : Exporter et Ajouter une transaction -->
        <div class="flex space-x-4">
            <!-- Bouton Exporter -->
            <a href="/api/transaction/user/csv">
                <button onclick="download()"
                    class="text-white bg-[#008250] hover:bg-[#006B3C] focus:ring-4 focus:outline-none focus:ring-green-300 font-medium rounded-lg text-sm px-5 py-2.5">
                    Exporter
                </button>
            </a>
            <!-- Bouton Ajouter une transaction -->
            <a href="/transactions">
                <button type="submit"
                    class="text-white bg-[#008250] hover:bg-[#006B3C] focus:ring-4 focus:outline-none focus:ring-green-300 font-medium rounded-lg text-sm px-5 py-2.5">
                    Ajouter une transaction
                </button>
            </a>
        </div>

        <!-- Tableau d'historique des transactions -->
        <!-- Tri par type ou date -->
        <div class="flex space-x-4 mt-4">
            <label for="sortBy" class="font-medium">Trier par :</label>
            <select id="sortBy" class="border p-2 rounded-lg">
                <option value="type">Type</option>
                <option value="date">Date</option>
            </select>

            <!-- Filtrer par période -->
            <label for="filterPeriod" class="font-medium">Filtrer par période :</label>
            <select id="filterPeriod" class="border p-2 rounded-lg">
                <option value="7">7 derniers jours</option>
                <option value="30">30 derniers jours</option>
                <option value="90">90 derniers jours</option>
                <option value="all">Toutes les transactions</option>
            </select>
        </div>
        <div class="overflow-x-auto w-full max-w-4xl">
            <table class="w-full text-sm text-left text-gray-500">
                <thead class="text-xs text-gray-700 uppercase bg-gray-200">
                    <tr>
                        <th scope="col" class="px-6 py-3">Date</th>
                        <th scope="col" class="px-6 py-3">Type</th>
                        <th scope="col" class="px-6 py-3">Montant</th>
                        <th scope="col" class="px-6 py-3">Solde</th>
                    </tr>
                </thead>
                <tbody id="tbody" class="bg-white">
                    <!-- Les entrées de transactions seront insérées ici -->
                </tbody>
            </table>
        </div>
    </div>

    <footer></footer>

    <script>

        document.addEventListener("DOMContentLoaded", () => {
            // Récupérer les paramètres de l'URL
            const urlParams = new URLSearchParams(window.location.search);
            const success = urlParams.get('success');

            // Vérifie si le paramètre 'success' est présent dans l'URL
            if (success === 'true') {
                const notification = document.getElementById("notification");
                const notificationMessage = document.getElementById("notification-message");
                notificationMessage.textContent = "Le fichier CSV a été téléchargé avec succès!";
                notification.classList.remove("hidden");

                // Efface le paramètre de l'URL après 3 secondes
                setTimeout(() => {
                    const url = new URL(window.location);
                    url.searchParams.delete('success');
                    window.history.replaceState({}, document.title, url);
                }, 3000);
            }
        });
        async function download() {
            try {
                // Making a GET request to the API
                const response = await fetch("/api/transaction/user/csv", {
                    method: "GET",
                });
                const data = await response;

                if (response.ok) {
                    const notification = document.getElementById("notification");
                    const notificationMessage = document.getElementById("notification-message");
                    notificationMessage.textContent = "Le fichier CSV a été téléchargé avec succès!";
                    notification.classList.remove("hidden");

                    // Efface le paramètre de l'URL après 3 secondes
                    setTimeout(() => {
                        const url = new URL(window.location);
                        url.searchParams.delete('success');
                        window.history.replaceState({}, document.title, url);
                    }, 3000);
                } else {
                    console.error("Error fetching transactions:", data.error);
                    // You can display an error message to the user here
                }
            } catch (error) {
                console.error("Fetch error:", error);
            }
        }
        // Fonction pour fermer la notification
        function closeNotification() {
            document.getElementById("notification").classList.add("hidden");
        }
    </script>
</body>

</html>
